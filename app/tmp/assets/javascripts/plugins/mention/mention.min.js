(function(a){a.fn.extend({mention:function(c){this.opts={users:[],delimiter:"@",sensitive:true,emptyQuery:false,queryBy:["name","username"],typeaheadOpts:{}};var f=a.extend({},this.opts,c),d=function(){if(typeof a=="undefined"){throw new Error("jQuery is Required")}else{if(typeof a.fn.typeahead=="undefined"){throw new Error("Typeahead is Required")}}return true},h=function(l,j){var k;for(k=j;k>=0;k--){if(l[k]==f.delimiter){break}}return l.substring(k,j)},e=function(l){var o;if(f.emptyQuery){var k=(this.query.toLowerCase()),r=this.$element[0].selectionStart,s=k.slice(r-1,r);if(s==f.delimiter){return true}}for(o in f.queryBy){if(l[f.queryBy[o]]){var u=l[f.queryBy[o]].toLowerCase(),p=(this.query.toLowerCase()).match(new RegExp(f.delimiter+"\\w+","g")),m;if(!!p){for(m=0;m<p.length;m++){var n=(p[m].substring(1)).toLowerCase(),t=new RegExp(f.delimiter+u,"g"),v=((this.query.toLowerCase()).match(t));if(u.indexOf(n)!=-1&&v===null){return true}}}}}},g=function(o){var p=this.query,j=this.$element[0].selectionStart,m;for(m=j;m>=0;m--){if(p[m]==f.delimiter){break}}var l=p.substring(m,j),n=p.substring(0,m),k=p.substring(j),p=n+f.delimiter+o+k;this.tempQuery=p;return p},b=function(n){if(n.length&&f.sensitive){var m=h(this.query,this.$element[0].selectionStart).substring(1),q,l=n.length,p={highest:[],high:[],med:[],low:[]},k=[];if(m.length==1){for(q=0;q<l;q++){var r=n[q];if((r.username[0]==m)){p.highest.push(r)}else{if((r.username[0].toLowerCase()==m.toLowerCase())){p.high.push(r)}else{if(r.username.indexOf(m)!=-1){p.med.push(r)}else{p.low.push(r)}}}}for(q in p){var o;for(o in p[q]){k.push(p[q][o])}}return k}}return n},i=function(j){var k=this;j=a(j).map(function(m,n){m=a(k.options.item).attr("data-value",n.username);var l=a("<div />");if(n.image){l.append('<img class="mention_image" src="'+n.image+'">')}if(n.name){l.append('<b class="mention_name">'+n.name+"</b>")}if(n.username){l.append('<span class="mention_username"> '+f.delimiter+n.username+"</span>")}m.find("a").html(k.highlighter(l.html()));return m[0]});j.first().addClass("active");this.$menu.html(j);return this};a.fn.typeahead.Constructor.prototype.render=i;return this.each(function(){var j=a(this);if(d()){j.typeahead(a.extend({source:f.users,matcher:e,updater:g,sorter:b},f.typeaheadOpts))}})}})})(jQuery);