{"version":3,"sources":["aslagle:reactive-table/lib/filter.js","aslagle:reactive-table/lib/server.js"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;AAAA,iD;AACA,mC;AACA,iC;AACA,mB;AACA,sC;;AAEA,sB;AACA,sB;AACA,iC;AACA,kB;AACA,sC;AACA,wE;AACA,wB;AACA,wB;AACA,c;AACA,6C;AACA,O;AACA,6C;AACA,sC;AACA,qD;AACA,c;AACA,uB;AACA,gD;AACA,O;AACA,Y;AACA,yB;AACA,K;AACA,K;AACA,iB;AACA,E;;AAEA,kC;AACA,0D;AACA,E;;AAEA,kE;AACA,4B;AACA,2C;AACA,iC;AACA,G;AACA,wB;AACA,mD;AACA,2E;AACA,8E;AACA,wC;AACA,W;AACA,c;AACA,8E;AACA,iF;AACA,W;AACA,O;AACA,O;AACA,G;AACA,6B;AACA,qB;AACA,iD;AACA,iB;AACA,+B;AACA,wE;AACA,yB;AACA,gC;AACA,uB;AACA,W;AACA,kC;AACA,kD;AACA,W;AACA,c;AACA,gD;AACA,+C;AACA,+C;AACA,iD;AACA,W;AACA,mC;AACA,wD;AACA,2D;AACA,2B;AACA,wC;AACA,wC;;AAEA,gD;AACA,mC;AACA,4D;AACA,gD;AACA,a;;AAEA,wC;AACA,iC;AACA,sC;AACA,8C;AACA,gD;AACA,iC;AACA,uC;AACA,8C;AACA,a;AACA,a;;AAEA,uC;AACA,uD;AACA,wC;AACA,W;AACA,W;AACA,O;AACA,K;AACA,K;AACA,qD;AACA,E;;AAEA,sB;AACA,sC;;AAEA,gC;AACA,qB;;AAEA,gD;AACA,mC;AACA,wC;AACA,K;AACA,M;AACA,mC;;AAEA,yB;;AAEA,4B;AACA,gC;AACA,M;;AAEA,wC;AACA,+B;AACA,iD;AACA,mB;AACA,S;AACA,M;AACA,M;AACA,oC;AACA,I;AACA,I;AACA,qD;AACA,2C;AACA,2C;AACA,+C;AACA,O;AACA,O;AACA,I;;AAEA,oD;AACA,2C;AACA,+C;AACA,iC;AACA,O;AACA,yC;AACA,O;AACA,I;;AAEA,2C;AACA,iD;AACA,0D;AACA,kB;AACA,O;AACA,kD;AACA,O;AACA,I;;AAEA,qD;AACA,iD;AACA,0D;AACA,wE;AACA,oE;AACA,wE;AACA,c;AACA,qD;AACA,O;AACA,O;AACA,I;;AAEA,wC;AACA,0B;AACA,yC;AACA,M;AACA,I;AACA,2B;AACA,yD;AACA,uD;AACA,O;AACA,iD;AACA,K;AACA,K;;AAEA,iE;AACA,2D;AACA,U;;AAEA,uC;AACA,kF;AACA,yC;AACA,6C;AACA,yC;AACA,M;AACA,K;AACA,C;;;;;;;;;;;;;;;;;;;ACtMA,mB;;AAEA,6F;AACA,8G;AACA,qB;AACA,mB;AACA,M;AACA,+C;AACA,qD;AACA,c;AACA,0C;AACA,O;;AAEA,sD;AACA,uE;AACA,kB;AACA,O;;AAEA,6C;AACA,iD;AACA,c;AACA,sC;AACA,O;AACA,sB;AACA,sF;AACA,wC;AACA,yC;AACA,O;AACA,yD;AACA,iC;;AAEA,0C;AACA,yB;AACA,6C;AACA,sC;AACA,gB;AACA,Q;;AAEA,iC;AACA,6C;AACA,Q;AACA,oB;AACA,wC;AACA,4B;AACA,S;;AAEA,oC;AACA,gC;AACA,+C;AACA,qC;AACA,uB;AACA,0C;AACA,iF;AACA,kC;AACA,a;AACA,kB;AACA,6E;AACA,gC;AACA,W;AACA,W;AACA,Q;;AAEA,yE;AACA,mC;AACA,yE;AACA,S;;AAEA,8B;;AAEA,0C;AACA,sC;AACA,8B;AACA,0F;AACA,yB;AACA,W;AACA,U;;AAEA,wC;AACA,wF;AACA,mE;AACA,0B;AACA,uB;AACA,U;;AAEA,wC;AACA,uB;AACA,S;;AAEA,S;AACA,2B;;AAEA,mB;;AAEA,+B;AACA,sB;AACA,S;AACA,O;AACA,E","file":"/packages/aslagle_reactive-table.js","sourcesContent":["var parseFilterString = function (filterString) {\n  var startQuoteRegExp = /^[\\'\\\"]/;\n  var endQuoteRegExp = /[\\'\\\"]$/;\n  var filters = [];\n  var words = filterString.split(' ');\n\n  var inQuote = false;\n  var quotedWord = '';\n  _.each(words, function (word) {\n    if (inQuote) {\n      if (endQuoteRegExp.test(word)) {\n        filters.push(quotedWord + ' ' + word.slice(0, word.length - 1));\n        inQuote = false;\n        quotedWord = '';\n      } else {\n        quotedWord = quotedWord + ' ' + word;\n      }\n    } else if (startQuoteRegExp.test(word)) {\n      if (endQuoteRegExp.test(word)) {\n        filters.push(word.slice(1, word.length - 1));\n      } else {\n        inQuote = true;\n        quotedWord = word.slice(1, word.length);\n      }\n    } else {\n      filters.push(word);\n    }\n  });\n  return filters;\n};\n\nvar escapeRegex = function(text) {\n  return text.replace(/[-[\\]{}()*+?.,\\\\^$|#\\s]/g, \"\\\\$&\");\n};\n\ngetFilterQuery = function (filterInputs, filterFields, settings) {\n  settings = settings || {};\n  if (settings.enableRegex === undefined) {\n    settings.enableRegex = false;\n  }\n  if (settings.fields) {\n    _.each(filterInputs, function (filter, index) {\n      if (_.any(settings.fields, function (include) { return include; })) {\n        filterFields[index] = _.filter(filterFields[index], function (field) {\n          return settings.fields[field];\n        });\n      } else {\n        filterFields[index] = _.filter(filterFields[index], function (field) {\n          return _.isUndefined(settings.fields[field]) || settings.fields[field];\n        });\n      }\n    });\n  }\n  var numberRegExp = /^\\d+$/;\n  var queryList = [];\n  _.each(filterInputs, function (filter, index) {\n    if (filter) {\n      if (_.isObject(filter)) {\n        var fieldQueries = _.map(filterFields[index], function (field) {\n          var query = {};\n          query[field] = filter;\n          return query;\n        });\n        if (fieldQueries.length) {\n            queryList.push({'$or': fieldQueries});\n          }\n      } else {\n        var filters = parseFilterString(filter);\n        _.each(filters, function (filterWord) {\n          if (settings.enableRegex === false) {\n            filterWord = escapeRegex(filterWord);\n          }\n          var filterQueryList = [];\n          _.each(filterFields[index], function (field) {\n            var filterRegExp = new RegExp(filterWord, 'i');\n            var query = {};\n            query[field] = filterRegExp;\n            filterQueryList.push(query);\n\n            if (numberRegExp.test(filterWord)) {\n              var numberQuery = {};\n              numberQuery[field] = parseInt(filterWord, 10);\n              filterQueryList.push(numberQuery);\n            }\n\n            if (filterWord === \"true\") {\n              var boolQuery = {};\n              boolQuery[field] = true;\n              filterQueryList.push(boolQuery);\n            } else if (filterWord === \"false\") {\n              var boolQuery = {};\n              boolQuery[field] = false;\n              filterQueryList.push(boolQuery);\n            }\n          });\n\n          if (filterQueryList.length) {\n            var filterQuery = {'$or': filterQueryList};\n            queryList.push(filterQuery);\n          }\n        });\n      }\n    }\n  });\n  return queryList.length ? {'$and': queryList} : {};\n};\n\nif (Meteor.isClient) {\n  ReactiveTable = ReactiveTable || {};\n\n  var reactiveTableFilters = {};\n  var callbacks = {};\n\n  ReactiveTable.Filter = function (id, fields) {\n    if (reactiveTableFilters[id]) {\n        return reactiveTableFilters[id];\n    }\n      \n    var filter = new ReactiveVar();\n\n    this.fields = fields;\n\n    this.get = function () {\n      return filter.get() || '';\n    };\n\n    this.set = function (filterString) {\n      filter.set(filterString);\n      _.each(callbacks[id], function (callback) {\n        callback();\n      });\n    };\n      \n    reactiveTableFilters[id] = this;\n  };\n    \n  ReactiveTable.clearFilters = function (filterIds) {\n    _.each(filterIds, function (filterId) {\n      if (reactiveTableFilters[filterId]) {\n        reactiveTableFilters[filterId].set('');\n      }\n    });\n  };\n\n  dependOnFilters = function (filterIds, callback) {\n    _.each(filterIds, function (filterId) {\n      if (_.isUndefined(callbacks[filterId])) {\n        callbacks[filterId] = [];\n      }\n      callbacks[filterId].push(callback);\n    });\n  };\n\n  getFilterStrings = function (filterIds) {\n    return _.map(filterIds, function (filterId) {\n      if (_.isUndefined(reactiveTableFilters[filterId])) {\n        return '';\n      }\n      return reactiveTableFilters[filterId].get();\n    });\n  };\n\n  getFilterFields = function (filterIds, allFields) {\n    return _.map(filterIds, function (filterId) {\n      if (_.isUndefined(reactiveTableFilters[filterId])) {\n        return _.map(allFields, function (field) { return field.key; });\n      } else if (_.isEmpty(reactiveTableFilters[filterId].fields)) {\n        return _.map(allFields, function (field) { return field.key; });\n      } else {\n        return reactiveTableFilters[filterId].fields;\n      }\n    });\n  };\n\n  Template.reactiveTableFilter.helpers({\n    'class': function () {\n      return this.class || 'input-group';\n    },\n    \n    'filter': function () {\n      if (_.isUndefined(reactiveTableFilters[this.id])) {\n        new ReactiveTable.Filter(this.id, this.fields);\n      }\n      return reactiveTableFilters[this.id].get();\n    }\n  });\n\n  var updateFilter = _.debounce(function (template, filterText) {\n    reactiveTableFilters[template.data.id].set(filterText);\n  }, 200);\n\n  Template.reactiveTableFilter.events({\n    'keyup .reactive-table-input, input .reactive-table-input': function (event) {\n      var template = Template.instance();\n      var filterText = $(event.target).val();\n      updateFilter(template, filterText);\n    },\n  });\n}\n","ReactiveTable = {};\n\nReactiveTable.publish = function (name, collectionOrFunction, selectorOrFunction, settings) {\n    Meteor.publish(\"reactive-table-\" + name, function (publicationId, filters, fields, options, rowsPerPage) {\n      var collection;\n      var selector;\n      \n      if (_.isFunction(collectionOrFunction)) {\n        collection = collectionOrFunction.call(this);\n      } else {\n        collection = collectionOrFunction;\n      }\n\n      if (!(collection instanceof Mongo.Collection)) {\n        console.log(\"ReactiveTable.publish: no collection to publish\");\n        return [];\n      }\n\n      if (_.isFunction(selectorOrFunction)) {\n        selector = selectorOrFunction.call(this);\n      } else {\n        selector = selectorOrFunction;\n      }\n      var self = this;\n      var filterQuery = _.extend(getFilterQuery(filters, fields, settings), selector);\n      if (settings && settings.fields) {\n        options.fields = settings.fields;\n      }\n      var cursor = collection.find(filterQuery, options);\n      var count = cursor.count();\n\n      var getRow = function (row, index) {\n        return _.extend({\n          \"reactive-table-id\": publicationId,\n          \"reactive-table-sort\": index\n        }, row);\n      };\n\n      var getRows = function () {\n        return _.map(cursor.fetch(), getRow);\n      };\n      var rows = {};\n      _.each(getRows(), function (row) {\n        rows[row._id] = row;\n      });\n\n      var updateRows = function () {\n        var newRows = getRows();\n        _.each(newRows, function (row, index) {\n          var oldRow = rows[row._id];\n          if (oldRow) {\n            if (!_.isEqual(oldRow, row)) {\n              self.changed(\"reactive-table-rows-\" + publicationId, row._id, row);\n              rows[row._id] = row;\n            }\n          } else {\n            self.added(\"reactive-table-rows-\" + publicationId, row._id, row);\n            rows[row._id] = row;\n          }\n        });\n      };\n\n      self.added(\"reactive-table-counts\", publicationId, {count: count});\n      _.each(rows, function (row) {\n        self.added(\"reactive-table-rows-\" + publicationId, row._id, row);\n      });\n\n      var initializing = true;\n\n      var handle = cursor.observeChanges({\n        added: function (id, fields) {\n          if (!initializing) {\n            self.changed(\"reactive-table-counts\", publicationId, {count: cursor.count()});\n            updateRows();\n          }\n        },\n\n        removed: function (id, fields) {\n          self.changed(\"reactive-table-counts\", publicationId, {count: cursor.count()});\n          self.removed(\"reactive-table-rows-\" + publicationId, id);\n          delete rows[id];\n          updateRows();\n        },\n\n        changed: function (id, fields) {\n          updateRows();\n        }\n\n      });\n      initializing = false;\n\n      self.ready();\n\n      self.onStop(function () {\n        handle.stop();\n      });\n    });\n};\n"]}